@{
    ViewData["Title"] = "智能小车控制面板";
}
@section Css{
    <link href="~/css/car.css" rel="stylesheet" />
}
<div class="text-center">
    <h5 class="display-4">控制面板</h5>
</div>
<ul class="Switch">
    <li>
        <input type="checkbox" name="Storage" id="csb" onclick="KZCSB(this)" />
        超声波
        <label for="csb"><em></em></label>
    </li>
    <li>
        <input type="checkbox" name="Storage2" id="bz" onclick="KZBZ(this)" />
        红外避障
        <label for="bz"><em></em></label>
    </li>
    <li>
        <input type="checkbox" name="Storage2" id="yk" onclick="KZWIFIYK(this)" checked="checked" />
        WiFi遥控
        <label for="yk"><em></em></label>
    </li>
    <li>
        <input type="checkbox" name="Storage2" id="yk" onclick="KZYK(this)" />
        红外遥控
        <label for="yk"><em></em></label>
    </li>
</ul>


<div class="control-wrapper">
    <div class="control-btn control-top" onclick="carmove(this,'up')">
        <i class="fa fa-chevron-up">↑</i>
        <div class="control-inner-btn control-inner"></div>
    </div>
    <div class="control-btn control-left" onclick="carmove(this,'left')">
        <i class="fa fa-chevron-left">←</i>
        <div class="control-inner-btn control-inner"></div>
    </div>
    <div class="control-btn control-bottom" onclick="carmove(this,'down')">
        <i class="fa fa-chevron-down"></i>
        <div class="control-inner-btn control-inner"></div>
    </div>
    <div class="control-btn control-right" onclick="carmove(this,'right')">
        <i class="fa fa-chevron-right">→</i>
        <div class="control-inner-btn control-inner"></div>
    </div>
    <div class="control-round" onclick="carmove(this,'pause')">
        <div class="control-round-inner">
            <i class="fa fa-pause-circle">P</i>
        </div>
    </div>
</div>

<div class="text-center">
    <h5>超声波数据</h5>
    <p id="csbdata" style="color:Red"></p>
</div>

<div class="text-center">
    <h5>红外避障数据</h5>
    <p id="bzdata" style="color:Red"></p>
</div>

@section Scripts{
    <script src="~/js/signalr.js"></script>
    <script>
        // 控制超声波
        function KZCSB(th) {
            if ($(th).is(':checked')) {
                $.get("/Hcsr04/Hcsr04On", function (data) {
                    console.log(data);
                });
            } else {
                $.get("/Hcsr04/Hcsr04Off", function (data) {
                    $("#csbdata").empty();
                    console.log(data);
                });
            }
        }
        // 控制红外避障
        function KZBZ(th) {
            if ($(th).is(':checked')) {
                $.get("/HJIR2/HJIR2On", function (data) {
                    console.log(data);
                });
            } else {
                $.get("/HJIR2/HJIR2Off", function (data) {
                     $("#bzdata").empty();
                    console.log(data);
                });
            }
        }
        // wifi遥控
        var isstop = false;
        function KZWIFIYK(th) {
            if ($(th).is(':checked')) {
                $.get("/L298N/Start", function (data) {
                    console.log(data);
                    isstop = false;
                });
            } else {
                $.get("/L298N/Stop", function (data) {
                    console.log(data);
                    isstop = true;
                });
            }
        }
        // 小车移动
        function carmove(th, type) {
            if (!isstop) {
                switch (type) {
                    case "up":
                        $.get("/L298N/Up", function (data) {
                            console.log(data);
                        });
                        break;
                    case "down":
                        $.get("/L298N/Down", function (data) {
                            console.log(data);
                        });
                        break;
                    case "left":
                        $.get("/L298N/Left", function (data) {
                            console.log(data);
                        });
                        break;
                    case "right":
                        $.get("/L298N/Right", function (data) {
                            console.log(data);
                        });
                        break;
                    case "pause":
                        $.get("/L298N/Pause", function (data) {
                            console.log(data);
                        });
                        break;
                }
                $(th).siblings('div').removeClass('CarClick');
                $(th).addClass('CarClick');
            }
        }

        // signalR 接受传感器数据
        var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub?groupName=lz").build();

        connection.on("ReceiveMessage", function (type, msg) {
            switch (type) {
                case "1":
                    $("#csbdata").text(msg);
                    break;
                case "2":
                    $("#bzdata").text(msg);
                    break;
                default:
                    break;
            }
        });

        connection.start().then(function () { }).catch(function (err) {
            return console.error(err.toString());
        });

        connection.onclose(async () => {
            $("#csbdata").empty();
            $("#bzdata").empty();
            console.info('监听到链接关闭');
            await start();
        });

        async function start() {
            try {
                await connection.start();
                console.log("connected");
            } catch (err) {
                console.log(err);
                setTimeout(() => start(), 5000); // 断线重连
            }
        };
    </script>
}